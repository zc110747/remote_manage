# 嵌入式Linux支持环境编译

## 1. uboot的编译
### 1.1 使用开发板厂商的编译uboot
&emsp;&emsp;说起来, uboot的编译一般流程为下载官方更新的分支，裁剪修改设备树，驱动配置符合使用硬件板的需求，然后执行脚本编译，不过这部分在后续文档中整理，这里演示用开发板提供的uboot直接编译(mx6ull_14x14_evk_emmc_defconfig在目录config下).<br />
&emsp;&emsp;将uboot复制到linux平台，执行如下命令.<br />

```bash
tar -xvf uboot-imx-2016.03-2.1.0-g9bd38ef-v1.0.tar.bz2
make distclean
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- mx6ull_14x14_evk_emmc_defconfig
make V=1 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j12
```

&emsp;&emsp;如果编译中显示缺少文件，基本上是上面提到的部分库未安装，找到安装即可, 编译目录下的**uboot.bin**即用到的boot文件.<br />

## 1.2 linux内核编译

&emsp;&emsp;linux的编译也类似, 这里也直接用开发板提供的内核.<br />

```bash
tar -xvf linux-imx-4.1.15-2.1.0-g49efdaa-v1.0.tar.bz2
vim arch/arm/boot/dts/Makefile
```

&emsp;&emsp;在CONFIG_SOC_IMX6ULL添加设备树，如我需要的是:
**imx6ull-14x14-emmc-4.3-800x480-c.dtb**.<br />
&emsp;&emsp;另外因为开发内核需求，设备树也要更新,将*kernal_mod/dts/imx6ull-14x14-evk.dts*复制到*arch/arm/boot/dts/*下覆盖.<br />

```bash
make distclean
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- imx_v7_defconfig
make V=1 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- all -j4
```

&emsp;&emsp;则编译后的文件位于如下目录下.<br />
```
arch/arm/boot/zImage  
arch/arm/boot/dts/imx6ull-14x14-emmc-4.3-800x480-c.dtb  
```
&emsp;&emsp;这两个文件即是编译需要用到的文件.<br />

&emsp;&emsp;编译错误分析:<br />
&emsp;&emsp;(1).编译中出现重复变量yylloc.<br />
```
scripts/dtc/dtc-parser.tab.o:(.bss+0x50): multiple definition of `yylloc'  
scripts/dtc/dtc-lexer.lex.o:(.bss+0x0): first defined here
```
&emsp;&emsp;在scripts/dtc/dtc-lexer.lex.c_shipped中的yylloc变量声明如下:<br />

```c
extern YYLTYPE yylloc;
```
&emsp;&emsp;重新执行编译脚本.<br />

## 3.嵌入式linux平台软件编译

### 3.1 编译嵌入式环境下的ssh服务
&emsp;&emsp;对于嵌入式linux平台，就需要自己编译openssh，这里给出说明.  
[1].下载zlib, openssl, openssh, 将所有文件下载并解压到/home/center/download/目录, 并分别编译这些库  

```bash
#下载zlib, openssl openssh
wget http://www.zlib.net/fossils/zlib-1.2.13.tar.gz
wget https://www.openssl.org/source/openssl-3.1.0.tar.gz
wget https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/OpenSSH/portable/openssh-9.3p1.tar.gz
tar -xvf zlib-1.2.13.tar.gz
tar -xvf openssl-3.1.0.tar.gz
tar -xvf openssh-9.3p1.tar.gz

#编译zlib库
cd zlib-1.2.13/
export CHOST=arm-linux-gnueabihf
./configure --prefix=/home/center/install/zlib
make & make install

#编译openssl库
cd ../openssl-3.0.7/
./config --cross-compile-prefix=arm-linux-gnueabihf- no-asm linux-aarch64 --prefix=/home/center/install/openssl
make & make install

#编译openssh库
cd ../openssh-9.3p1/
./configure --host=arm-linux-gnueabihf --with-libs --with-zlib="/home/center/install/zlib" --with-ssl-dir="/home/center/install/openssl" --disable-etc-default-login 
make
```
编译完成后，目录下的scp sftp ssh sshd ssh-add ssh-agent ssh-keygen ssh-keyscan文件，即是编译后的执行文件.  

[2].上传文件到嵌入式linux平台，并创建运行环境  
创建以下目录(存在则不需要创建)  

```bash
mkdir /usr/local/bin
mkdir /usr/local/etc
mkdir /usr/libexec
mkdir /var/run
mkdir /var/empty
```

将scp, sftp, ssh, sshd, ssh-agent, ssh-keygen, ssh-keyscan拷贝到/usr/local/bin目录.  
将sftp-server, ssh-keysign拷贝到/usr/libexec目录.  
将moduli, ssh_config, sshd_config拷贝到/usr/local/etc目录.  
在嵌入式平台生成ssh对应密钥  

```bash
cd /usr/bin/etc
/usr/local/bin/ssh-keygen -t rsa -f ssh_host_rsa_key -N ""
/usr/local/bin/ssh-keygen -t dsa -f ssh_host_dsa_key -N ""
/usr/local/bin/ssh-keygen -t ecdsa -f ssh_host_ecdsa_key -N ""
/usr/local/bin/ssh-keygen -t dsa -f ssh_host_ed25519_key -N ""
```

生成完成后，在/etc/passwd中添加sshd用户支持  

```bash
sshd:x:115:65534::/var/run/sshd:/usr/sbin/nologin
```

当然也要和上面桌面端一样，在/usr/local/etc/sshd_config添加支持的加密算法，然后执行.  

```bash
/usr/local/bin/sshd
```

出错处理
1.显示缺少libz.so.1,需要将上面zlib安装目录下的/home/center/download/openssh-9.1p1/zlib/lib/中的库复制到嵌入式文件系统的/usr/lib下  
2.出现加密算法不匹配, 需要在桌面端/etc/ssh/ssh_config和嵌入式linux平台/usr/local/etc/sshd_config中添加如下字段  

```bash
Ciphers aes128-cbc
MACs  hmac-md5
KexAlgorithms diffie-hellman-group1-sha1
```

### 3.2 编译和安装sqlite
1.下载和编译sqlite
```bash
wget https://www.sqlite.org/src/tarball/sqlite.tar.gz
```

